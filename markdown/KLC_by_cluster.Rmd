---
title: "KLC_by_cluster"
output: html_document
date: "2025-02-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# KLC by cluster

## Preliminary steps

Load libraries

```{r include=FALSE}
# Packages that need to be loaded
pacman::p_load(caret, citation, data.table, dplyr, earth, farff, ggpubr, ggplot2, iml, knitr, rpart, tidyverse , tidyr, xtable)
library(GGally) # extensi√≥n de ggplot2
library(factoextra) # visualizacion de los clusters
library(NbClust) # determinar el mejor numero de grupos
library(cluster) # medidas de evaluacion como silhouette

```

Load files

```{r include=FALSE}
# Load files
datasets <- readRDS("files/datasets.rds")
method_names = readRDS("files/method_names.rds")
noise_level <- readRDS("files/noise.rds")
noise_names <- readRDS("files/noise_names.rds")
instances_names = readRDS("files/instances_names.rds")
quartiles_names = c("25", "50", "75", "100")

#characteristics_df = readRDS("files/clustering/characteristics.rds")

# Load results
results_df <- readRDS("results/results_plot_d.rds")
results_df <- results_df %>% select(-accuracy, -kappa, -dataset_order, -method_order)

quartiles_df <- readRDS("results/results_plot_q.rds")
quartiles_df <- quartiles_df %>% select(-accuracy, -kappa, -dataset_order, -method_order)

meanKLC <- readRDS("results/meanKLC.rds") # This is df2 from Classification
meanKLC_q <- readRDS("results/meanKLC_q.rds") # This is df2_q from Classification
```

```{r eval=FALSE, include=FALSE}
# Get the highest kappa loss for each technique in each quartile
meanKLC_results <- meanKLC_q[meanKLC_q$noise == 100, c("technique", "percentage", "kappa_loss")]
print(meanKLC_results)

```

```{r echo=FALSE}
# Transform the data
wide_data <- meanKLC_q %>%
  unite("noise_percentage", noise, percentage, sep = "_") %>%
  spread(key = noise_percentage, value = kappa_loss)

# View the transformed data
print(wide_data)
```

```{r}
clusters <- cutree(hclusters, k = 4)

print(clusters)
```

```{r}
# First get unique techniques in the same order as used for clustering
techniques <- wide_data$technique  # assuming technique is a column in wide_data

# Create the mapping dataframe
technique_clusters <- data.frame(
  technique = techniques,
  cluster = clusters
)

# Now join with original data and filter
meanKLC_q_with_clusters <- meanKLC_q %>%
  left_join(technique_clusters, by = "technique")

# Get the highest kappa loss for each cluster in each quartile
cluster_results <- meanKLC_q_with_clusters[c("cluster", "noise", "percentage", "kappa_loss")]
print(cluster_results)

```

```{r}
# Calculate mean kappa loss for each cluster, noise level, and percentage
cluster_means <- cluster_results %>%
  group_by(cluster, noise, percentage) %>%
  summarize(kappa_loss = round(mean(kappa_loss, na.rm = TRUE), 2)) %>%
  ungroup()

print(cluster_means)
```

```{r echo=TRUE}
for(instance in quartiles_names) {
  # Filter data for the current instance percentage
  filtered_data <- subset(meanKLC_q, percentage == instance & noise != 5)
  
  # Create plot
  p2 <- ggplot(filtered_data, aes(x = noise, y = kappa_loss, color = factor(technique))) +
  geom_point() +
  geom_line(aes(noise)) +
  labs(x = "Noise", y = "Kappa Loss", color = "Technique") +
  ggtitle(paste0("Kappa Loss Curves by technique, noise and ", instance, " % of instances altered")) +
  theme_bw() +
  scale_y_continuous(limits = c(0.0, 0.5), breaks = seq(0, 1, by = 0.1))
  
  # Print plot
  print(p2)
}

```

```{r echo=TRUE}
for(instance in quartiles_names) {
  # Filter data for the current instance percentage
  filtered_data <- subset(cluster_means, percentage == instance & noise != 5)
  
  # Create plot
  p3 <- ggplot(filtered_data, aes(x = noise, y = kappa_loss, color = factor(cluster))) +
  geom_point() +
  geom_line(aes(noise)) +
  labs(x = "Noise", y = "Kappa Loss", color = "Cluster") +
  ggtitle(paste0("Kappa Loss Curves by cluster, noise and ", instance, " % of instances altered")) +
  theme_bw() +
  scale_y_continuous(limits = c(0.0, 0.5), breaks = seq(0, 1, by = 0.1))
  
  # Print plot
  print(p3)
}

```

```{r}
for(instance in quartiles_names) {
  # Filter data for both techniques and clusters
  filtered_tech_data <- subset(meanKLC_q, percentage == instance & noise != 5)
  filtered_cluster_data <- subset(cluster_means, percentage == instance & noise != 5)
  
  # Create combined plot
  combined_plot <- ggplot() +
    # Add technique lines with transparency
    geom_line(data = filtered_tech_data, 
              aes(x = noise, y = kappa_loss, color = factor(technique), linetype = "Technique"),
              alpha = 0.2) +  # Set transparency for techniques
    geom_point(data = filtered_tech_data,
               aes(x = noise, y = kappa_loss, color = factor(technique)),
               alpha = 0.2) +  # Matching point transparency
    
    # Add cluster lines (solid)
    geom_line(data = filtered_cluster_data,
              aes(x = noise, y = kappa_loss, color = factor(cluster), linetype = "Cluster")) +
    geom_point(data = filtered_cluster_data,
               aes(x = noise, y = kappa_loss, color = factor(cluster))) +
    
    # Customize the plot
    scale_y_continuous(limits = c(0.0, 0.5), breaks = seq(0, 1, by = 0.1)) +
    scale_linetype_manual(name = "Type",
                         values = c("Technique" = "solid", "Cluster" = "solid")) +
    labs(x = "Noise",
         y = "Kappa Loss",
         color = "Method",
         title = paste0("Kappa Loss Curves by technique and cluster\n",
                       instance, "% of instances altered")) +
    theme_bw() +
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5))
  
  # Print combined plot
  print(combined_plot)
}
```
