---
title: "IDEAL Functions"
output:
  html_document: default
  pdf_document: default
date: "2024-06-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

------------------------------------------------------------------------

# Preliminary steps

### Load necessary libraries and files

#### Load libraries

```{r, include=FALSE}
# Packages that need to be loaded
pacman::p_load(caret, citation, data.table, dplyr, earth, farff, ggpubr, ggplot2, iml, knitr, rpart, tidyverse , tidyr, xtable, factoextra, proxy, dominanceanalysis, clustertend, MASS, smacof, flexclust, ggrepel)

setwd("~/rscripts/code")

```

#### Load files

```{r, include=FALSE}
# Load files
test_data <- readRDS("files/clustering/test_data.rds")
#techniques <- c("rda", "rf", "C5.0", "svmRadial", "mlpML", "naive_bayes", "knn", "gcvEarth", "simpls", "JRip") # "bayesglm", "multinom"
techniques <- readRDS("files/method_names.rds")
train_set <- readRDS("files/clustering/train_set.rds")
test_set <- readRDS("files/clustering/test_set.rds")
centroids <- readRDS("files/clustering/centroids.rds")
kcca <- readRDS("files/clustering/kcca.rds")

# Load results
results_df <- readRDS("results/results_plot_d.rds")
plots <- readRDS("files/clustering/plots.rds")
groups_df <- readRDS("files/clustering/groups.rds")

```

------------------------------------------------------------------------

# Classification of each new dataset

### Get cluster assignment with K-Centroids Cluster Analysis

```{r echo=FALSE}
# Predict cluster assignment for new dataset
kcca_assignment <- predict(kcca, newdata = test_set[,-1])

# Print the cluster assignment
print(kcca_assignment)
  
```

### Get cluster assignment with Euclidean distance to centroids

#### Calculate the distance for each point to its assigned centroid

```{r echo=FALSE}
for(i in 1:nrow(test_set)) {
  # Calculate Euclidean distance between the new vector and each centroid
  distances <- apply(centroids, 1, function(centroid) sqrt(sum((i - centroid)^2)))
  
  # Determine the nearest centroid
  cluster_assignment <- which.min(distances)
  
  # Print the cluster assignment
  print(cluster_assignment)
  if(i != nrow(test_set)) {print("----------------")}
}
```

# Functions

## Function 1

```{r include=FALSE}
test_cl2 <- c("analcatdata_authorship", "breast-w", "liver-disorders")
test_cl1 <- c("cardiotocography")
noise_levels <- c("_10", "_20", "_30")
noise_list <- c(10, 20, 30)
kappa_thresholds <- c(0.05, 0.10, 0.15)
```

### Cluster Kappa loss

```{r include=FALSE}
# Create a dataframe to store the summary
cluster_loss <- data.frame(
  cluster = numeric(0),
  technique = character(0),
  noise = numeric(0),
  instances = numeric(0),
  kappa_threshold = numeric(0),
  cluster_kappa_loss = numeric(0)
)

# For each cluster
for(i in 1:4) {
  # For each technique
  for(tech in techniques) {
    # For each level of noise
    for(n_level in noise_levels) {
      # For each level of kappa loss
      for(threshold in kappa_thresholds) {
        plot_name <- paste0(tech, n_level)
        if (plot_name %in% names(plots)) {
          res <- as.data.frame(plots[[plot_name]]$data)
          
          # Filter the data for cluster 2
          res_cluster <- subset(res, cluster  == i)
          
          # Calculate 1 - mean_kappa
          res_cluster$kappa_loss <- round(1 - res_cluster$mean_kappa, 2)
          
          # Filter where 1 - kappa is less than or equal to the kappa threshold
          filtered_res <- subset(res_cluster, kappa_loss <= threshold)
          
          if (nrow(filtered_res) > 0) {
            # Get the row with the highest value in the instances column
            best_instance <- filtered_res[which.max(filtered_res$percentage), ]
            
            # Add the best instance to the summary dataframe
            cluster_loss <- bind_rows(cluster_loss, data.frame(
              cluster = best_instance$cluster,
              technique = best_instance$technique,
              noise = best_instance$noise,
              instances = best_instance$percentage,
              kappa_threshold = threshold,
              cluster_kappa_loss = best_instance$kappa_loss
            ))
          }
        }
      }
    }
  }
}
  
```

### Test set Kappa loss

```{r include=FALSE}
# Create a dataframe to store the summary
test_loss <- data.frame(
 dataset_name = character(0),
 technique = character(0),
 noise = numeric(0),
 instances = numeric(0),
 kappa_threshold = numeric(0),
 test_kappa_loss = numeric(0)
)

# For each test dataset
for(dataset in test_data) {
  # For each technique
  for(tech in techniques) {
    # For each level of noise
    for(n in noise_list) {
      # For each level of kappa loss
      for(threshold in kappa_thresholds) {
        #Filter data by dataset
        data <- subset(results_df, dataset_name == dataset)
        
        # Calculate 1 - mean_kappa
        data$kappa_loss <- round(1 - data$kappa, 3)
        
        # Filter by technique
        data <- subset(data, technique == tech)
        
        # Filter data by noise level
        data <- subset(data, noise == n)
        
        # Filter by target kappa
        data <- subset(data, kappa_loss <= threshold)
        
        # Get the highest value in the percentage column
        if (nrow(data) > 0) {
          # Get the row with the highest value in the instances column
          best_instance <- data[which.max(data$percentage), ]
          
          # Add the best instance to the summary dataframe
          test_loss <- bind_rows(test_loss, data.frame(
            dataset_name = best_instance$dataset_name,
            technique = best_instance$technique,
            noise = best_instance$noise,
            instances = best_instance$percentage,
            kappa_threshold = threshold,
            test_kappa_loss = best_instance$kappa_loss
          ))
        }
      }
    }
  }
}

```

### **`analcatdata_authorship, breast-w and liver-disorders`**

These datasets belong to cluster 2 in K-Centroids Cluster Analysis

```{r include=FALSE}
# Compare the results and create the final summary dataframe
cl2_loss <- data.frame(
  dataset_name = character(0),
  technique = character(0),
  noise = numeric(0),
  kappa_threshold = numeric(0),
  cl_instances = numeric(0),
  cl_kappa_loss = numeric(0),
  test_instances = numeric(0),
  test_kappa_loss = numeric(0),
  result = logical(0)
)

# Filter for each cluster
cl_data <- subset(cluster_loss, cluster == 2)

for(dataset in test_cl2) {
  for(i in 1:nrow(cl_data)) {
    # Extract corresponding values from cl_data
    cl_row <- cl_data[i, ]
    
    # Find the corresponding row in test_loss
    test_row <- subset(test_loss, dataset_name == dataset & technique == cl_row$technique & noise == cl_row$noise & kappa_threshold == cl_row$kappa_threshold)
    
    print(paste0("Row: ", i))
    print(paste0("Technique: ", cl_row$technique, ", ", test_row$technique))
    print(paste0("Noise: ", cl_row$noise, ", ", test_row$noise))
    print(paste0("Kappa threshold: ", cl_row$kappa_threshold, ", ", test_row$kappa_threshold))
    print("----")
    
    if (nrow(test_row) > 0) {
      # Compare cl_kappa_loss and test_kappa_loss
      result <- if (cl_row$instances <= test_row$instances) TRUE else FALSE
      
      # Add to final summary
      cl2_loss <- bind_rows(cl2_loss, data.frame(
        dataset_name = test_row$dataset_name,
        technique = cl_row$technique,
        noise = cl_row$noise,
        kappa_threshold = cl_row$kappa_threshold,
        cl_instances = cl_row$instances,
        cl_kappa_loss = cl_row$cluster_kappa_loss,
        test_instances = test_row$instances,
        test_kappa_loss = test_row$test_kappa_loss,
        result = result
      ))
    }
  }
}

```

### **`cardiotocography`**

This dataset belongs to cluster 1 in K-Centroids Cluster Analysis

```{r include=FALSE}
# Compare the results and create the final summary dataframe
cl1_loss <- data.frame(
  dataset_name = character(0),
  technique = character(0),
  noise = numeric(0),
  kappa_threshold = numeric(0),
  cl_instances = numeric(0),
  cl_kappa_loss = numeric(0),
  test_instances = numeric(0),
  test_kappa_loss = numeric(0),
  result = logical(0)
)

# Filter for each cluster
cl_data <- subset(cluster_loss, cluster == 1)

for(dataset in test_cl1) {
  for(i in 1:nrow(cl_data)) {
    # Extract corresponding values from cl_data
    cl_row <- cl_data[i, ]
    
    # Find the corresponding row in test_loss
    test_row <- subset(test_loss, dataset_name == dataset & technique == cl_row$technique & noise == cl_row$noise & kappa_threshold == cl_row$kappa_threshold)
    
    print(paste0("Row: ", i))
    print(paste0("Technique: ", cl_row$technique, ", ", test_row$technique))
    print(paste0("Noise: ", cl_row$noise, ", ", test_row$noise))
    print(paste0("Kappa threshold: ", cl_row$kappa_threshold, ", ", test_row$kappa_threshold))
    print("----")
    
    if (nrow(test_row) > 0) {
      # Compare cl_kappa_loss and test_kappa_loss
      result <- if (cl_row$instances <= test_row$instances) TRUE else FALSE
      
      # Add to final summary
      cl1_loss <- bind_rows(cl1_loss, data.frame(
        dataset_name = test_row$dataset_name,
        technique = cl_row$technique,
        noise = cl_row$noise,
        kappa_threshold = cl_row$kappa_threshold,
        cl_instances = cl_row$instances,
        cl_kappa_loss = cl_row$cluster_kappa_loss,
        test_instances = test_row$instances,
        test_kappa_loss = test_row$test_kappa_loss,
        result = result
      ))
    }
  }
}

```

### Merge the results of all test data

```{r include=FALSE}
# Merge the dataframes
loss_summary <- rbind(cl1_loss, cl2_loss)
```

### Plots

```{r echo=FALSE}
# Define targets
for(target_name in test_data) {
  # For each level of noise
  for(n in noise_list) {
    # Filter data for the current dataset and level of noise
    plot_data <- subset(loss_summary, dataset_name == target_name & noise == n)
    
    # Convert kappa_threshold to a factor to make it discrete
    plot_data$kappa_threshold <- factor(plot_data$kappa_threshold)
    
    # Create plot
    p <- ggplot(plot_data, aes(x = cl_instances, y = kappa_threshold)) +
      geom_point() +
      #geom_jitter(aes(color = result), width = 0, height = 0.5) + 
      geom_text_repel(aes(label = technique, color = result), max.overlaps = 30, size = 3, force = 10) + 
      #geom_text(aes(label = technique), vjust = 0, hjust = -0.2, size = 3) + 
      xlim(0, 100) +
      scale_color_manual(values = c("TRUE" = "darkgreen", "FALSE" = "red")) +
      labs(x = "Instances", y = "Kappa Threshold", color = "Precision") +
      ggtitle(paste0("Dataset ", target_name, " with noise ", n)) +
      theme_bw()
    
    # Print plot
    print(p)
    #ggsave("plot.png", p, width = 20, height = 16, dpi = 600)
  }
}
```

```{r echo=FALSE}
# Calculate successes, failures, and accuracy
accuracy_summary <- loss_summary %>%
  group_by(dataset_name, noise, kappa_threshold) %>%
  summarise(
    successes = sum(result == "TRUE"),
    failures = sum(result == "FALSE"),
    accuracy = successes / (successes + failures)
  )

# Print the resulting table
print(accuracy_summary)
```

```{r echo=FALSE}
# Convert the resulting table to LaTeX format
latex_table1 <- xtable(accuracy_summary)

# Print the LaTeX code
print(latex_table1, type = "latex")
```

Other plots

```{r eval=FALSE, include=FALSE}
# Identify elements ending with "_10"
elements_to_plot <- grep("_10$", names(plots), value = TRUE)

# Plot the data for each of these elements
for (element in elements_to_plot) {
  plot_data <- plots[[element]]
  plot(
    plot_data,
    type = "l",
    main = paste("Plot of", element),
    xlab = "Index",
    ylab = "Value"
  )
}

# Identify elements ending with "_30"
elements_to_plot <- grep("_20$", names(plots), value = TRUE)

# Plot the data for each of these elements using base R
for (element in elements_to_plot) {
  plot_data <- plots[[element]]
  plot(
    plot_data,
    type = "l",
    main = paste("Plot of", element),
    xlab = "Index",
    ylab = "Value"
  )
}

# Identify elements ending with "_10"
elements_to_plot <- grep("_30$", names(plots), value = TRUE)

# Plot the data for each of these elements using base R
for (element in elements_to_plot) {
  plot_data <- plots[[element]]
  plot(
    plot_data,
    type = "l",
    main = paste("Plot of", element),
    xlab = "Index",
    ylab = "Value"
  )
}

```

### Original plots for **`analcatdata_authorship`**

```{r eval=FALSE, include=FALSE}
# Define targets
target_name <- "analcatdata_authorship"
for(target_technique in techniques) {

    # Filter data for the current dataset and method
    filtered_data <- subset(results_df, dataset_name == target_name & technique == target_technique & noise >= 10 & noise <= 30)
    
    # Create plot
    p <- ggplot(filtered_data, aes(x = percentage, y = kappa, color = factor(noise))) +
      geom_point() +
      geom_line(aes(group = factor(noise))) +
      labs(x = "Instances", y = "Kappa", color = "Noise") +
      theme_bw() +
      scale_y_continuous(limits = c(0.1, 1), breaks = seq(0, 1, by = 0.1)) 
      #facet_grid(method_order ~ dataset_order, scales = "free")
    
    # Print plot
    print(p)
    #ggsave("plot.png", p, width = 20, height = 16, dpi = 600)
}

```

```{r eval=FALSE, include=FALSE}
# Define targets
target_name <- "breast-w"
for(target_technique in techniques) {

    # Filter data for the current dataset and method
    filtered_data <- subset(results_df, dataset_name == target_name & technique == target_technique & noise >= 10 & noise <= 30)
    
    # Create plot
    p <- ggplot(filtered_data, aes(x = percentage, y = kappa, color = factor(noise))) +
      geom_point() +
      geom_line(aes(group = factor(noise))) +
      labs(x = "Instances", y = "Kappa", color = "Noise") +
      theme_bw() +
      scale_y_continuous(limits = c(0.1, 1), breaks = seq(0, 1, by = 0.1)) 
      #facet_grid(method_order ~ dataset_order, scales = "free")
    
    # Print plot
    print(p)
    #ggsave("plot.png", p, width = 20, height = 16, dpi = 600)
}

```

```{r eval=FALSE, include=FALSE}
# Define targets
target_name <- "liver-disorders"
for(target_technique in techniques) {

    # Filter data for the current dataset and method
    filtered_data <- subset(results_df, dataset_name == target_name & technique == target_technique & noise >= 10 & noise <= 30)
    
    # Create plot
    p <- ggplot(filtered_data, aes(x = percentage, y = kappa, color = factor(noise))) +
      geom_point() +
      geom_line(aes(group = factor(noise))) +
      labs(x = "Instances", y = "Kappa", color = "Noise") +
      theme_bw() +
      scale_y_continuous(limits = c(0.1, 1), breaks = seq(0, 1, by = 0.1)) 
      #facet_grid(method_order ~ dataset_order, scales = "free")
    
    # Print plot
    print(p)
    #ggsave("plot.png", p, width = 20, height = 16, dpi = 600)
}

```

## Function 2

```{r include=FALSE}
# Define targets
target_name <- "cardiotocography"
target_threshold <- 0.10
```

```{r include=FALSE}
# Get the results from cluster 1
cluster_2 <- groups_df$dataset_name[groups_df$kmeans_4 == 1]

# Filter data for the current dataset and method
results_c2 <- results_df %>%
  filter(dataset_name %in% cluster_2)

# Group by number of instances and noise, then calculate mean kappa value
c2_means <- results_c2 %>%
  group_by(technique, noise, percentage) %>%
  summarise(mean_kappa = mean(kappa, na.rm = TRUE)) %>%
  ungroup()

c2_means$kappa_loss <- round(1 - c2_means$mean_kappa, 3)
c2_means <- subset(c2_means, technique %in% techniques)
c2_means <- subset(c2_means, noise %in% noise_list)

```

```{r echo=FALSE}
# Define targets
for(n in noise_list) {
  # Filter data for the current dataset and method
  plot_data <- subset(c2_means, noise == n)
  
  # Create plot
  p <- ggplot(plot_data, aes(x = percentage, y = kappa_loss, color = factor(technique))) +
    geom_point() +
    geom_line(aes(group = factor(technique))) +
    xlim(0, 100) +
    labs(x = "Instances", y = "Kappa loss", color = "Technique") +
    ggtitle(paste("Cluster: ", 1, " Noise: ", n)) +
    theme_bw() +
    scale_y_continuous(limits = c(0.0, 1), breaks = seq(0, 1, by = 0.1))

  print(p)
}

```

```{r echo=FALSE}
filtered_means <- subset(c2_means, noise == 10)

# Filter and arrange the dataframe
filtered_sorted <- filtered_means %>%
  filter(kappa_loss <= 0.05) %>%
  group_by(technique) %>%
  slice_max(order_by = percentage, n = 1) %>%
  ungroup() %>%
  arrange(desc(percentage))


# Print the resulting table
print(filtered_sorted)

```

```{r echo=FALSE}
# Convert the resulting table to LaTeX format
latex_table <- xtable(filtered_sorted)

# Print the LaTeX code
print(latex_table, type = "latex")
```

```{r include=FALSE}
# Get Kappa loss in order to print Kappa Loss Curves
# Calculate 1 - mean_kappa rounded to two decimals
results_df$kappa_loss <- round(1 - results_df$kappa, 3)
```

```{r}
# Filter the dataframe
filtered_results_df <- results_df[results_df$technique %in% techniques, ]


```

```{r echo=FALSE}
for(n in noise_list) {
  # Filter data for the current dataset and method
  plot_data <- subset(filtered_results_df, dataset_name == "liver-disorders" & noise == n)
  
  # Create plot
  p <- ggplot(plot_data, aes(x = percentage, y = kappa_loss, color = factor(technique))) +
    geom_point() +
    geom_line(aes(group = factor(technique))) +
    geom_hline(yintercept = 0.05, linetype = "dotted", color = "blue") +  # Add dotted line at kappa_loss = 5
    labs(x = "Instances", y = "Kappa loss", color = "Technique") +
    ggtitle(paste("Dataset: ", "liver-disorders", " Noise: ", n)) +
    theme_bw() +
    scale_y_continuous(limits = c(0.0, 0.5), breaks = seq(0, 1, by = 0.1))

  print(p)
  
  # Filter and arrange the dataframe
  filtered_sorted <- plot_data %>%
    filter(kappa_loss <= 0.05) %>%
    group_by(technique) %>%
    slice_max(order_by = percentage, n = 1) %>%
    ungroup() %>%
    arrange(desc(percentage))
  
  
  # Print the resulting table
  print(filtered_sorted)
  
  latex_table <- xtable(filtered_sorted)
  
  # Print the LaTeX code
  print(latex_table, type = "latex")
}
```
