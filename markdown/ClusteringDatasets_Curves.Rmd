---
title: "ClusteringDatasets_Curves"
output: html_document
date: "2025-04-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preliminary steps

### Load necessary libraries and files

#### Load libraries

```{r, include=FALSE}
# Packages that need to be loaded
pacman::p_load(ggplot2, tidyverse , tidyr, factoextra, proxy, dominanceanalysis, clustertend, MASS, smacof, vegan, cluster, flexclust)
library(ggplot2)
library(dplyr)
library(reshape2)
library(patchwork)

```

#### Load files

```{r, include=FALSE}
# Load files
datasets <- c("analcatdata_authorship", "badges2", "banknote", "blood-transfusion-service-center", "breast-w", "cardiotocography", "climate-model-simulation-crashes", "cmc", "credit-g", "diabetes", "eucalyptus", "iris", "kc1", "liver-disorders", "mfeat-karhunen", "mfeat-zernike", "ozone-level-8hr", "pc4", "phoneme", "qsar-biodeg", "tic-tac-toe", "vowel", "waveform-5000", "wdbc", "wilt")
method_names = c("C5.0", "ctree", "fda", "gbm", "gcvEarth", "JRip", "lvq", "mlpML", "multinom", "naive_bayes", "PART", "rbfDDA", "rda", "rf", "rpart", "simpls", "svmLinear", "svmRadial", "rfRules", "knn", "bayesglm")
noise_level = c(0, 0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)
noise_names = c("noise_0", "noise_5", "noise_10", "noise_20", "noise_30", "noise_40", "noise_50", "noise_60", "noise_70", "noise_80", "noise_90", "noise_100")
instances_names <- c("0", "10", "20", "30", "40", "50", "60", "70", "80", "90", "100") # Set names for percentages of instances to be altered
quartiles_names = c("0", "25", "50", "75", "100")

train_set <- readRDS("../files/clustering/train_set.rds")
test_set <- readRDS("../files/clustering/test_set.rds")
kmeans <- readRDS("../files/clustering/kmeans.rds")
centroids_4 <- readRDS("../files/clustering/centroids.rds")
kcca <- readRDS("../files/clustering/kcca.rds")

```

```{r echo=FALSE}
# Visualize the clusters
plot(fviz_cluster(kmeans, data = train_set[,-1], 
             geom = "point", ellipse.type = "convex", 
             ggtheme = theme_minimal()) + coord_fixed(ratio = 1))
```

```{r echo=FALSE}
quartiles_df <- readRDS(file = "results/results_plot_q.rds")

# Create a new column to control the order of datasets
quartiles_df$dataset_order <- factor(quartiles_df$dataset_name, levels = datasets)

# Create a new column to control the order of methods
quartiles_df$method_order <- factor(quartiles_df$technique, levels = method_names)

# Create plot
p <- ggplot(quartiles_df, aes(x = percentage, y = kappa_loss, color = factor(noise))) +
  geom_point() +
  geom_line(aes(group = factor(noise))) +
  labs(x = "Instances", y = "Kappa", color = "Noise") +
  theme_bw() +
  scale_y_continuous(limits = c(0.0, 1), breaks = seq(0, 1, by = 0.1)) +
  facet_grid(method_order ~ dataset_order, scales = "free")

# Print plot
print(p)
```

```{r}
# Create plots for visualizing kappa loss per cluster and quartile
create_cluster_quartile_plots <- function(quartiles_df, kmeans_obj, datasets, method_names,
                                          save_path = NULL, combined = FALSE) {
  # Step 1: Create a mapping from dataset name to cluster
  dataset_cluster_map <- data.frame(
    dataset_name = datasets,
    cluster = kmeans_obj$cluster
  )
  
  # Step 2: Join cluster information to the main dataframe
  data_with_clusters <- merge(quartiles_df, dataset_cluster_map, by = "dataset_name")
  
  # Step 3: Get unique clusters and quartiles
  clusters <- sort(unique(data_with_clusters$cluster))
  quartiles <- sort(unique(data_with_clusters$percentage))
  
  # Step 4: Convert noise column to numeric for proper ordering
  # Assuming noise column is in format "noise_X" where X is the percentage
  data_with_clusters <- data_with_clusters %>%
    mutate(noise_numeric = as.numeric(str_replace(str_replace(noise, "noise_", ""), "00$", "0")) / 100)
  
  # Step 5: Create plots
  plot_list <- list()
  
  for (cluster_id in clusters) {
    for (q in quartiles) {
      # Filter data for this cluster and quartile
      plot_data <- data_with_clusters %>%
        filter(cluster == cluster_id, percentage == q)
      
      # Create plot
      p <- ggplot(plot_data, aes(x = noise_numeric, y = kappa_loss, color = technique, group = technique)) +
        geom_line() +
        geom_point(size = 1.5) +
        scale_x_continuous(
          name = "Noise Level",
          breaks = seq(0, 1, by = 0.1),
          labels = scales::percent_format()
        ) +
        scale_y_continuous(
          name = "Kappa Loss",
          limits = c(0, 1),
          breaks = seq(0, 1, by = 0.1)
        ) +
        scale_color_viridis_d(name = "Method") +  # Better color palette for many methods
        ggtitle(paste("Cluster", cluster_id, "- Quartile", q, "%")) +
        theme_minimal() +
        theme(
          legend.position = "right",
          legend.text = element_text(size = 8),
          panel.grid.minor = element_blank(),
          plot.title = element_text(size = 12, face = "bold"),
          axis.title = element_text(size = 10),
          axis.text = element_text(size = 8)
        )
      
      # Store in list
      plot_name <- paste("Cluster", cluster_id, "Quartile", q)
      plot_list[[plot_name]] <- p
      
      # Save individual plot if path provided
      if (!is.null(save_path)) {
        file_name <- file.path(save_path, paste0("cluster_", cluster_id, "_quartile_", q, ".pdf"))
        ggsave(file_name, p, width = 10, height = 7)
      }
    }
  }
  
  # If combined is TRUE, create a combined plot arrangement
  if (combined) {
    combined_plots <- list()
    
    for (cluster_id in clusters) {
      # Get all plots for this cluster
      cluster_plots <- plot_list[grep(paste0("Cluster ", cluster_id), names(plot_list))]
      
      # Combine using patchwork
      combined_plot <- wrap_plots(cluster_plots, ncol = length(quartiles))
      combined_plots[[paste0("Cluster_", cluster_id)]] <- combined_plot
      
      # Save if path provided
      if (!is.null(save_path)) {
        file_name <- file.path(save_path, paste0("combined_cluster_", cluster_id, ".pdf"))
        ggsave(file_name, combined_plot, width = 18, height = 10)
      }
    }
    
    return(combined_plots)
  }
  
  return(plot_list)
}

# Alternative approach using facets
create_faceted_plots <- function(quartiles_df, kmeans_obj, datasets, 
                                save_path = NULL) {
  # Create dataset to cluster mapping
  dataset_cluster_map <- data.frame(
    dataset_name = datasets,
    cluster = kmeans_obj$cluster
  )
  
  # Join cluster information
  data_with_clusters <- merge(quartiles_df, dataset_cluster_map, by = "dataset_name")
  
  # Convert noise to numeric
  data_with_clusters <- data_with_clusters %>%
    mutate(noise_numeric = as.numeric(str_replace(str_replace(noise, "noise_", ""), "00$", "0")) / 100,
           percentage_factor = factor(percentage, levels = c("0", "25", "50", "75", "100")),
           cluster_factor = factor(cluster))
  
  # Create faceted plot - one facet grid per cluster
  plots <- list()
  
  for (cluster_id in unique(data_with_clusters$cluster)) {
    cluster_data <- data_with_clusters %>% filter(cluster == cluster_id)
    
    p <- ggplot(cluster_data, aes(x = noise_numeric, y = kappa_loss, color = technique, group = technique)) +
      geom_line() +
      geom_point() +
      scale_x_continuous(
        name = "Noise Level",
        breaks = seq(0, 1, by = 0.2),
        labels = scales::percent_format()
      ) +
      scale_y_continuous(
        name = "Kappa Loss",
        limits = c(0, 1),
        breaks = seq(0, 1, by = 0.2)
      ) +
      facet_wrap(~ percentage_factor, nrow = 1, labeller = labeller(percentage_factor = function(x) paste0("Quartile ", x, "%"))) +
      theme_minimal() +
      theme(
        legend.position = "right",
        strip.text = element_text(size = 10, face = "bold"),
        strip.background = element_rect(fill = "lightgrey", color = NA),
        panel.spacing = unit(0.5, "lines"),
        legend.text = element_text(size = 8)
      ) +
      ggtitle(paste("Cluster", cluster_id)) +
      scale_color_viridis_d(name = "Method")
    
    plots[[paste0("Cluster_", cluster_id)]] <- p
    
    if (!is.null(save_path)) {
      file_name <- file.path(save_path, paste0("facet_cluster_", cluster_id, ".pdf"))
      ggsave(file_name, p, width = 15, height = 7)
    }
  }
  
  return(plots)
}
```
