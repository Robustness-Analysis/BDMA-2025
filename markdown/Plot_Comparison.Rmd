---
title: "Comparison of KLC Curves when top and popular attribute differ"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Plot Comparison

## Preliminary steps
```{r include=FALSE}
# Packages that need to be loaded
library(dplyr)
library(tidyr)
library(ggplot2)
library(GGally) # extensi√≥n de ggplot2
library(factoextra) # visualizacion de los clusters
library(NbClust) # determinar el mejor numero de grupos
library(cluster) # medidas de evaluacion como silhouette
library(gridExtra) # For grid.arrange to place plots side by side
library(grid) # For text grobs
```

Load files

```{r include=FALSE}
# Load files
datasets <- readRDS("../files/datasets.rds")
method_names = readRDS("../files/method_names.rds")
# Remove svmLinear for testing on most popular key attribute
method_names <- method_names[! method_names %in% c("svmLinear")]
noise_level <- readRDS("../files/noise.rds")
noise_names <- readRDS("../files/noise_names.rds")
instances_names = readRDS("../files/instances_names.rds")

# Load results
KLC_res <- readRDS("../results/KLC_plot_deciles.rds") 
KLC_p <- readRDS("../results/KLC_plot_deciles_popular.rds") 
```

## Extract and Compare Plots for mfeat-zernike with multinom

We'll extract the data for the 'mfeat-zernike' dataset with the 'multinom' technique from both datasets.

```{r}
# Filter data for mfeat-zernike dataset and multinom technique from both datasets
mfeat_multinom_top <- KLC_res %>%
  filter(dataset_name == "mfeat-zernike" & technique == "multinom")

mfeat_multinom_popular <- KLC_p %>%
  filter(dataset_name == "mfeat-zernike" & technique == "multinom")

# Print the number of rows in each filtered dataset
cat("Top attribute dataset rows:", nrow(mfeat_multinom_top), "\n")
cat("Popular attribute dataset rows:", nrow(mfeat_multinom_popular), "\n")
```

Now we'll create and display the plots side by side:

```{r fig.width=12, fig.height=6}
# Create plot for top attribute
plot_top <- ggplot(mfeat_multinom_top, aes(x = percentage, y = kappa_loss, color = factor(noise))) +
  geom_point() +
  geom_line(aes(group = factor(noise))) +
  labs(title = "mfeat-zernike with multinom (Top Attribute)",
       x = "Instances", 
       y = "Kappa Loss", 
       color = "Noise") +
  theme_bw() +
  scale_y_continuous(limits = c(0.0, 1), breaks = seq(0, 1, by = 0.1))

# Create plot for popular attribute
plot_popular <- ggplot(mfeat_multinom_popular, aes(x = percentage, y = kappa_loss, color = factor(noise))) +
  geom_point() +
  geom_line(aes(group = factor(noise))) +
  labs(title = "mfeat-zernike with multinom (Popular Attribute)",
       x = "Instances", 
       y = "Kappa Loss", 
       color = "Noise") +
  theme_bw() +
  scale_y_continuous(limits = c(0.0, 1), breaks = seq(0, 1, by = 0.1))

# Display plots side by side
grid.arrange(plot_top, plot_popular, ncol = 2)
```

Save the comparison plot:

```{r}
# Save the comparison plot
comparison_plot <- grid.arrange(plot_top, plot_popular, ncol = 2)
ggsave("../results/plots/mfeat_zernike_multinom_comparison.png", comparison_plot, width = 40, height = 40, dpi = 600)
```

## Analyze Differences

Let's also calculate some statistics to compare the two datasets:

```{r}
# Calculate mean kappa loss for each noise level in both datasets
top_stats <- mfeat_multinom_top %>%
  group_by(noise) %>%
  summarise(
    mean_kappa_loss = mean(kappa_loss),
    sd_kappa_loss = sd(kappa_loss)
  )

popular_stats <- mfeat_multinom_popular %>%
  group_by(noise) %>%
  summarise(
    mean_kappa_loss = mean(kappa_loss),
    sd_kappa_loss = sd(kappa_loss)
  )

# Combine the stats
combined_stats <- top_stats %>%
  rename(top_mean = mean_kappa_loss, top_sd = sd_kappa_loss) %>%
  left_join(popular_stats %>% 
              rename(popular_mean = mean_kappa_loss, popular_sd = sd_kappa_loss),
            by = "noise") %>%
  mutate(difference = top_mean - popular_mean)

# Print the combined stats
print(combined_stats)
```

Let's also create a plot showing the difference in mean kappa loss between the two methods:

```{r fig.width=8, fig.height=5}
# Plot the difference in mean kappa loss
ggplot(combined_stats, aes(x = factor(noise), y = difference)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Difference in Mean Kappa Loss (Top - Popular)",
       x = "Noise Level", 
       y = "Difference") +
  theme_bw()
```